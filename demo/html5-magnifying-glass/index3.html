<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Glass</title>
    <style type="text/css">
        #canvas {
            display: block;
            border: 1px solid red;
            margin: 0 auto;
            /*cursor: crosshair;*/
            cursor: pointer;
            background: #ffffff;
        }
    </style>
</head>
<body>
<canvas id="canvas" width="500" height="500">


</canvas>

<img src="camp.png" style="display: none" id="img">

<script src="//cdn.bootcss.com/jquery/3.1.1/jquery.min.js" type="text/javascript"></script>

<script type="text/javascript">
    var canvas = document.getElementById("canvas");
    var context = canvas.getContext("2d");
    var img = document.getElementById("img");
    var scale = 8;

    var glassCenterPoint;
    var glassRadius = 50;
    var glassRectangle = {};
    var scaleGlassRectangle = {};
    /*var startPoints = new Array();
     var endPoints = new Array();
     var scaleStartPoints;
     var scaleEndPoints;
     var scalePointSize;*/

    var chartLines = new Array();
    var glassLines;
    var scaleGlassLines;
    var glassLineSize;


    var lastPoint = {};
    var moveGlass = false;

    var mouseUpId;
    var mouseDownId;

    window.onload = function () {
        initLinePoints();
        addListener();
        drawBackGround();
        calGlassRectangle(glassCenterPoint);
        drawGlass();

    }

    function Point(x, y, index) {
        this.x = x;
        this.y = y;
        this.index = index;
    }

    function Line(xStart, yStart, xEnd, yEnd, index, color) {

        this.xStart = xStart;
        this.yStart = yStart;
        this.xEnd = xEnd;
        this.yEnd = yEnd;
        this.index = index;
        this.color = color;
    }

    function initLinePoints() {
        /*var point;
         point = new Point(200.5, 200, 0);
         endPoints.push(point);
         point = new Point(200.5, 400, 0);
         startPoints.push(point);
         point = new Point(201.5, 20, 1);
         endPoints.push(point);
         point = new Point(201.5, 400, 1);
         startPoints.push(point);
         scaleStartPoints = new Array(startPoints.length);
         scaleEndPoints = new Array(endPoints.length);
         scalePointSize = startPoints.length;*/
        glassCenterPoint = {x: 200, y: 200};

        var line;
        line = new Line(200.5, 400, 200.5, 200, 0, "#aaa");
        chartLines.push(line);
        line = new Line(201.5, 400, 201, 20, 1, "#aaa");
        chartLines.push(line);
        glassLineSize = chartLines.length;
        glassLines = new Array(glassLineSize);
        for (var i = 0; i < glassLineSize; i++) {
            line = new Line(0, 0, 0, 0, i);
            glassLines[i] = line;
        }

        scaleGlassLines = new Array(glassLineSize);
        for (var i = 0; i < glassLineSize; i++) {
            line = new Line(0, 0, 0, 0, i);
            scaleGlassLines[i] = line;
        }
    }

    function drawBackGround() {
        //context.drawImage(img, 0, 0);


        //console.log(linePoints.length);
        var line;
        context.lineWidth = 1;
        /* context.strokeStyle = "#000";*/

        /*for (var i = 0; i < points.length; i++) {
         context.moveTo(points[i].x, 400);/*canvas.onmousemove = function (e) {
         glassCenterPoint = windowToCanvas(e.clientX, e.clientY);
         context.clearRect(0, 0, canvas.width, canvas.height);
         drawBackGround();
         calGlassRectangle(glassCenterPoint);
         drawGlass();
         }
         context.lineTo(points[i].x, points[i].y);
         }*/

        for (var i = 0; i < chartLines.length; i++) {
            line = chartLines[i];
            context.beginPath();
            context.strokeStyle = line.color;
            /*var bbox = canvas.getBoundingClientRect()
             return {x: x - bbox.left, y: y - bbox.top}*/
            context.moveTo(line.xStart, line.yStart);
            context.lineTo(line.xEnd, line.yEnd);
            context.stroke();
        }

    }


    function calGlassRectangle(point) {
        //var top, left, bottom, right;
        //var radius = glassRadius / scale;
        glassRectangle.x = point.x - glassRadius;
        glassRectangle.y = point.y - glassRadius;
        glassRectangle.width = glassRadius * 2;
        glassRectangle.height = glassRadius * 2;

        /*console.log(glassCenterPoint.x, glassCenterPoint.y);*/

        /*glassRectangle.x = point.x - radius;
         glassRectangle.y = point.y - radius;
         glassRectangle.width = radius * 2;
         glassRectangle.height = radius * 2;*/
        scaleGlassRectangle.width = glassRectangle.width * scale;
        scaleGlassRectangle.height = glassRectangle.height * scale;
        scaleGlassRectangle.x = glassRectangle.x + glassRectangle.width / 2 - scaleGlassRectangle.width / 2;
        scaleGlassRectangle.y = glassRectangle.y + glassRectangle.height / 2 - scaleGlassRectangle.height / 2;

        scaleGlassRectangle.width = parseInt(scaleGlassRectangle.width);
        scaleGlassRectangle.height = parseInt(scaleGlassRectangle.height);
        scaleGlassRectangle.x = parseInt(scaleGlassRectangle.x);
        scaleGlassRectangle.y = parseInt(scaleGlassRectangle.y);
        /*console.log("scaleGlassRectangle x", scaleGlassRectangle.x);
         console.log("scaleGlassRectangle y", scaleGlassRectangle.y);*/

        /*top = glassRectangle.y;
         left = glassRectangle.x;
         bottom = glassRectangle.y + glassRectangle.height;
         right = glassRectangle.x + glassRectangle.width;

         if (left < 0) {
         glassRectangle.width += left;
         glassRectangle.x = 0;
         } else if (right > canvas.width) {chartLines.length/*canvas.onmousemove = function (e) {
         glassCenterPoint = windowToCanvas(e.clientX, e.clientY);
         context.clearRect(0, 0, canvas.width, canvas.height);
         drawBackGround();
         calGlassRectangle(glassCenterPoint);
         drawGlass();
         }*/

    }


    function drawGlass() {

        /*var scaleGlassRectangle = {
         width: glassRectangle.width * scale,
         height: glassRectangle.height * scale
         };*/
        context.save();
        context.beginPath();
        context.arc(glassCenterPoint.x, glassCenterPoint.y, glassRadius, 0, Math.PI * 2, false);
        context.clip();

        context.beginPath();
        context.fillStyle = "#fff";
        context.arc(glassCenterPoint.x, glassCenterPoint.y, glassRadius, 0, Math.PI * 2, false);
        context.fill();

        /*console.log(glassCenterPoint.x, glassCenterPoint.y);*/


        /*context.drawImage(canvas,
         glassRectangle.x, glassRectangle.y,
         glassRectangle.width, glassRectangle.height,
         glassRectangle.x + glassRectangle.width / 2 - scaleGlassRectangle.width / 2,
         glassRectangle.y + glassRectangle.height / 2 - scaleGlassRectangle.height / 2,
         scaleGlassRectangle.width, scaleGlassRectangle.height
         );*/


        calScalePoint();

        context.lineWidth = 4;
        for (var i = 0; i < glassLineSize; i++) {
            context.beginPath();
            context.strokeStyle = scaleGlassLines[i].color;
            context.moveTo(scaleGlassRectangle.x + scaleGlassLines[i].xStart, scaleGlassRectangle.y + scaleGlassLines[i].yStart);
            context.lineTo(scaleGlassRectangle.x + scaleGlassLines[i].xEnd, scaleGlassRectangle.y + scaleGlassLines[i].yEnd);
            context.stroke();
            //console.log(scaleGlassRectangle.x + scaleGlassLines[i].xStart, scaleGlassRectangle.y + scaleGlassLines[i].yStart);
            //console.log(scaleGlassRectangle.x + scaleGlassLines[i].xEnd, scaleGlassRectangle.y + scaleGlassLines[i].yEnd);
        }


        context.restore();

        context.beginPath();
        var gradientThickness = 10;
        var gradient = context.createRadialGradient(
                parseInt(glassCenterPoint.x), parseInt(glassCenterPoint.y), glassRadius - 5,
                parseInt(glassCenterPoint.x), parseInt(glassCenterPoint.y), glassRadius);
        gradient.addColorStop(0, 'rgba(0,0,0,1)');
        gradient.addColorStop(0.80, 'silver');
        gradient.addColorStop(0.90, 'silver');
        gradient.addColorStop(1.0, 'rgba(0,0,0,1)');
        /*gradient.addColorStop(0,"red");
         gradient.addColorStop(1,"white");*/
        context.strokeStyle = gradient;
        context.lineWidth = 5;
        context.arc(parseInt(glassCenterPoint.x), parseInt(glassCenterPoint.y), glassRadius, 0, Math.PI * 2, false);
        context.stroke();


        drawAnchor();
        //console.log(glassCenterPoint.x, glassCenterPoint.y);
    }

    function drawAnchor() {
        context.beginPath();
        context.lineWidth = 2;
        context.fillStyle = "#fff";
        context.strokeStyle = "#000";
        context.arc(parseInt(glassCenterPoint.x), parseInt(glassCenterPoint.y), 10, 0, Math.PI * 2, false);

        var radius = 15;
        context.moveTo(parseInt(glassCenterPoint.x - radius), parseInt(glassCenterPoint.y));
        context.lineTo(parseInt(glassCenterPoint.x + radius), parseInt(glassCenterPoint.y));
        context.moveTo(parseInt(glassCenterPoint.x), parseInt(glassCenterPoint.y - radius));
        context.lineTo(parseInt(glassCenterPoint.x), parseInt(glassCenterPoint.y + radius));
        //context.fill();
        context.stroke();
    }

    function calScalePoint() {
        var xStart = glassRectangle.x;
        var xEnd = glassRectangle.x + glassRectangle.width;
        var yStart = glassRectangle.y;
        var yEnd = glassRectangle.y + glassRectangle.height;
        var line, gLine, sgLine;
        var glassLineIndex = 0;
        for (var i = 0; i < chartLines.length; i++) {
            /*console.log(111);*/
            line = chartLines[i];
            /*console.log(line.xStart, line.xEnd);
             console.log(xStart, yEnd);*/
            if (line.xStart < xStart || line.xEnd > xEnd) {
                //context.stroke();
                //console.log(111);
                continue;
            }
            if (line.yEnd > yEnd || line.yStart < yStart) {
                //scaleGlassRectangle.y + scaleGlassLines[i].yStart
                //console.log(line.yEnd, yStart);
                //console.log(line.yStart, yEnd);
                //console.log(222);
                continue;
            }
            //console.log(111);
            gLine = glassLines[glassLineIndex];
            sgLine = scaleGlassLines[glassLineIndex];
            if (line.yEnd > yEnd) {
                gLine.yEnd = yEnd;
            }
            if (line.yStart < yStart) {
                gLine.yStart = yStart;
            }

            gLine.xStart = line.xStart - xStart;
            gLine.yStart = line.yStart - yStart;
            gLine.xEnd = line.xEnd - xStart;
            gLine.yEnd = line.yEnd - yStart;
            sgLine.xStart = parseInt(gLine.xStart * scale);
            sgLine.yStart = parseInt(gLine.yStart * scale);
            sgLine.xEnd = parseInt(gLine.xEnd * scale);
            sgLine.yEnd = parseInt(gLine.yEnd * scale);
            sgLine.color = line.color;
            glassLineIndex++;
        }
        glassLineSize = glassLineIndex;

    }

    function drawGlassCircle() {

    }

    function changeValue() {
        glassCenterPoint.y = glassCenterPoint.y - 0.1;
    }

    function addListener() {
        /*canvas.onmousemove = function (e) {
         glassCenterPoint = windowToCanvas(e.clientX, e.clientY);
         context.clearRect(0, 0, canvas.width, canvas.height);
         drawBackGround();
         calGlassRectangle(glassCenterPoint);
         drawGlass();
         }*/

        canvas.onmousedown = function (e) {

            var point = windowToCanvas(e.clientX, e.clientY);

            var x1, x2, y1, y2, dis;
            x1 = point.x;
            y1 = point.y;
            x2 = glassCenterPoint.x;
            y2 = glassCenterPoint.y;
            console.log(1111);
            dis = Math.pow(x2 - x1, 2) + Math.pow(y2 - y1, 2);
            if (dis < Math.pow(glassRadius, 2)) {
                console.log(222);
                lastPoint.x = point.x;
                lastPoint.y = point.y;
                moveGlass = true;
            }
        }
    }

    canvas.onmousemove = function (e) {
        if (moveGlass) {
            var xDis, yDis;
            var point = windowToCanvas(e.clientX, e.clientY);
            xDis = point.x - lastPoint.x;
            yDis = point.y - lastPoint.y;
            glassCenterPoint.x += xDis;
            glassCenterPoint.y += yDis;
            lastPoint.x = point.x;
            lastPoint.y = point.y;
            context.clearRect(0, 0, canvas.width, canvas.height);
            drawBackGround();
            calGlassRectangle(glassCenterPoint);
            drawGlass();
        }
    }

    canvas.onmouseup = function (e) {
        moveGlass = false;
    }

    canvas.ondblclick = function (e) {
        console.log(111);
    }


    /*canvas.onclick = function (e) {

     var xStart, xEnd, yStart, yEnd;
     /!*var clickPoint = windowToCanvas(e.clientX, e.clientY);
     clickPoint.x += 4;*!/
     var clickPoint = {};
     clickPoint.x = scaleGlassRectangle.x + scaleGlassRectangle.width / 2;
     clickPoint.y = scaleGlassRectangle.y + scaleGlassRectangle.height / 2;
     var index = -1;

     for (var i = 0; i < scaleGlassLines.length; i++) {
     var scaleLine = scaleGlassLines[i];
     /!*console.log("scaleLine.x", scaleLine.xStart, scaleLine.xEnd);
     console.log("scaleLine.y", scaleLine.yStart, scaleLine.yEnd);*!/

     xStart = scaleGlassRectangle.x + scaleLine.xStart - 3;
     xEnd = scaleGlassRectangle.x + scaleLine.xStart + 3;
     yStart = scaleGlassRectangle.y + scaleLine.yStart;
     yEnd = scaleGlassRectangle.y + scaleLine.yEnd;
     console.log(xStart, clickPoint.x, xEnd);
     console.log(yStart, clickPoint.y, yEnd);
     if (clickPoint.x > xStart && clickPoint.x < xEnd && clickPoint.y < yStart && clickPoint.y > yEnd) {
     scaleLine.color = "#f00";
     index = scaleLine.index;
     console.log(index);
     break;
     }
     }
     for (var i = 0; i < chartLines.length; i++) {
     var line = chartLines[i];
     if (line.index == index) {
     line.color = "#f00";
     } else {
     line.color = "#000";
     }
     }
     }*/


    function intAdd(num, num2) {
        return (num * 100 + num2 * 100) / 100
    }

    document.onkeyup = function (e) {
        if (e.key == 'w') {
            glassCenterPoint.y  = intAdd(glassCenterPoint.y, -0.2);
        }
        if (e.key == 'a') {
            glassCenterPoint.x = intAdd(glassCenterPoint.x, -0.2);
        }
        if (e.key == 's') {
            glassCenterPoint.y = intAdd(glassCenterPoint.y, 0.2);
        }
        if (e.key == 'd') {
            glassCenterPoint.x = intAdd(glassCenterPoint.x, 0.2);
        }
        context.clearRect(0, 0, canvas.width, canvas.height);
        drawBackGround();
        calGlassRectangle(glassCenterPoint);
        drawGlass();
    }

    function windowToCanvas(x, y) {
        var bbox = canvas.getBoundingClientRect();
        //console.log(bbox);
        /*return {
         x: x - bbox.left * (canvas.width / bbox.width),
         y: y - bbox.top * (canvas.height / bbox.height)
         };*/
        var bbox = canvas.getBoundingClientRect()
        return {x: x - bbox.left, y: y - bbox.top}
    }

</script>
</body>
</html>